name: Volume Bot - AI Trading Strategist

on:
  schedule:
    # Peak hours EST (cada 4 horas)
    - cron: '0 13 * * *'  # 8am EST
    - cron: '0 17 * * *'  # 12pm EST
    - cron: '0 21 * * *'  # 4pm EST
    - cron: '0 1 * * *'   # 8pm EST
  workflow_dispatch:  # Manual trigger
    inputs:
      target_volume:
        description: 'Target volume in MON'
        required: false
        default: '50'
      duration:
        description: 'Duration in minutes'
        required: false
        default: '60'

env:
  NODE_VERSION: '20'

jobs:
  generate-volume:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master  # Checkout master branch for code

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Note: cache removed - file doesn't exist in gh-pages default branch

      - name: Install dependencies
        working-directory: scripts/trading-bot
        run: npm install

      - name: Check current hour (skip night hours)
        id: time-check
        run: |
          HOUR=$(TZ='America/New_York' date +%H)
          echo "Current EST hour: $HOUR"
          if [ $HOUR -ge 2 ] && [ $HOUR -lt 8 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping - night hours (2am-8am EST)"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Select random token
        if: steps.time-check.outputs.skip != 'true'
        id: token
        run: |
          TOKENS=(4 5 6 7 8)
          RANDOM_TOKEN=${TOKENS[$RANDOM % ${#TOKENS[@]}]}
          echo "token=$RANDOM_TOKEN" >> $GITHUB_OUTPUT
          echo "Selected token: #$RANDOM_TOKEN"

      - name: Calculate random volume
        if: steps.time-check.outputs.skip != 'true'
        id: volume
        run: |
          # Random volume between 30-100 MON
          MIN=30
          MAX=100
          VOLUME=$((RANDOM % (MAX - MIN + 1) + MIN))
          echo "volume=$VOLUME" >> $GITHUB_OUTPUT
          echo "Target volume: $VOLUME MON"

      - name: Run AI Strategist
        if: steps.time-check.outputs.skip != 'true'
        working-directory: scripts/trading-bot
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENSEA_API_KEY: ${{ secrets.OPENSEA_API_KEY }}
        run: |
          echo "Running AI Strategist..."
          echo "Token: #${{ steps.token.outputs.token }}"
          echo "Volume: ${{ steps.volume.outputs.volume }} MON"
          node volume-generator.mjs auto-ai ${{ steps.token.outputs.token }} ${{ steps.volume.outputs.volume }} 60

      - name: Send FOMO notification
        if: success() && steps.time-check.outputs.skip != 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Random FOMO messages
          MESSAGES=(
            "New activity detected on Monad Lands! Check OpenSea"
            "Lands are moving! Someone just scooped up a rare one"
            "Volume spike on the collection - whales are watching"
            "Another sale! The collection is heating up"
            "Trading activity detected - check the marketplace"
          )
          MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$MSG\"}" \
               $DISCORD_WEBHOOK || true
